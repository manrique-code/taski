<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraciones</title>
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.css">
    <style>
        .a-eliminar{
            text-decoration: none !important;
        }
    </style>
</head>
<body>

    <div class="container mt-3">

        <h1>Configuraciones</h1>

        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                 <a class="nav-item nav-link active" 
                 id="nav-asignaturas"
                 data-toggle="tab" 
                 href="#nav-asignatura" 
                 role="tab" 
                 aria-controls="nav-asignatura" 
                 aria-selected="true">Asignatura</a>

                 
                 <a class="nav-item nav-link" 
                 id="nav-contact-tab" 
                 data-toggle="tab" 
                 href="#nav-contact" 
                 role="tab" 
                 aria-controls="nav-contact" 
                 aria-selected="false">Periodos académicos</a>
                 
                <a class="nav-item nav-link" 
                   id="nav-profile-tab" 
                   data-toggle="tab" 
                   href="#nav-profile" 
                   role="tab" 
                   aria-controls="nav-profile" 
                   aria-selected="false">Tus datos</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">

        <!--Asignaturas-->
        <div class="tab-pane fade show active mt-3" 
                id="nav-asignatura" 
                role="tabpanel" 
                aria-labelledby="nav-asignaturas">
        
                <div class="row">

                <div class="col-6">
            
                    <p>                        
                        <small class="form-text text-muted">
                            Ingresa aquí las asignaturas que impartes para después asignarles
                            un horario correspondiente.
                        </small>    
                    </p>

                    <p>
                        <label for="txt-nombre-asignatura">Nombre de la asignatura</label>
                        <input type="text" class="form-control" id="txt-nombre-asignatura" placeholder="Español">
                        <input type="hidden" id="txt-id-asignatura">
                        <a href="#" id="btn-add-clase" style="display: none;">Establecer horario a la asignatura</a>
                    </p>
            
                    <p><button class="btn btn-primary btn-lg" id="btn-guardar-asignatura">Guardar</button></p>
            
                </div>

                <div class="col-6">
                    <h4>Lista de tus asignaturas</h4>
                    <table id="table" class=" table table-striped table-hover" >
            
                        <thead>
                            <tr>
                                <th class="text-left">Nombre</th>
                                <th class="text-center">Editar</th>
                                <th class="text-center">Eliminar</th>
                            </tr>

                            <tbody id="tdata-asignatura">

                            </tbody>
                        </thead>
            
                    </table>
                </div>
            
            </div>                

        </div>

        <!--Periodo-->
        <div class="tab-pane fade mt-3" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab">
            <div class="row">
                <div class="col-6">

                    <p>
                        <label for="txt-periodo">Número de periodo</label>
                        <input type="number" class="form-control" id="txt-periodo">
                    </p>

                    <p>
                        <label for="fecha-comienzo">¿Cuando comienza el periodo académico?</label>
                        <input type="date" class="form-control" id="fecha-comienzo">
                    </p>
                    
                    <p>
                        <label for="fecha-fin">¿Cuando termina el periodo académico?</label>
                        <input type="date" class="form-control" id="fecha-fin">
                    </p>

                    <p><button class="btn btn-primary btn-lg" id="btn-guardar-periodo">Guardar</button></p>

                </div>
                <div class="col-6">
                    <h4>Listado de periodos</h4>
                    <table class="table table-stripped table-hover">
                        <thead>
                            <tr>
                                <th class="text-left">N° Periodo</th>
                                <th class="text-left">Inicio</th>
                                <th class="text-left">Fin</th>
                                <th class="text-center">Actualizar</th>
                                <th class="text-center">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="tdata-periodo">

                        </tbody>
                    </table>

                </div>
            </div>
        </div>
        
        <!--Docente-->
        <div class="tab-pane fade mt-3" 
             id="nav-profile" 
             role="tabpanel" 
             aria-labelledby="nav-profile-tab">
            
             <div class="row">

                <div class="col">
            
                    <p>
                        <label for="txt-rtn">Número de identidad</label>
                        <input type="text" class="form-control" id="txt-rtn" placeholder="01XX-19XX-00XXX">
                    </p>
            
                    <div class="form-row mb-3">
                        <div class="col">
                            <label for="txt-nombre">Nombre</label>
                            <input type="text" class="form-control" id="txt-nombre" placeholder="José">
                        </div>
                        <div class="col">
                            <label for="txt-apellido">Apellido</label>
                            <input type="text" class="form-control" id="txt-apellido" placeholder="Madero"> 
                        </div>
                    </div>
            
                    <p>
                        <label for="txt-fecha">Fecha de nacimiento</label>
                        <input type="date" name="" id="txt-fecha" class="form-control">
                    </p>
            
                    <p>
                        <label for="cbo-titulo">
                            Te trataré por:                      
                        </label>
                        <select name="" id="cbo-titulo">
                            <option value="">Tú nombre</option>
                            <option value="Licenciado">Licenciado</option>
                            <option value="Ingeniero">Ingeniero</option>
                            <option value="Doctor">Doctor</option>
                        </select>
                    </p>
            
                    <hr>
            
                    <div class="custom-control custom-switch mb-3">
                        <input class="custom-control-input" type="checkbox" id="swc-cuenta">
                        <label class="custom-control-label" for="swc-cuenta">Asegurar mi información con una cuenta</label>
                    </div>
            
                    <div class="mb-3" id="user" style="display:none">
                        <div>
                            <label for="txt-usuario">Usuario</label>
                            <input type="text" class="form-control" id="txt-usuario">
                        </div>
                        <div>                        
                            <label for="txt-contra">Contraseña</label>
                            <input type="password" name="" id="txt-contra" class="form-control">
                        </div>                    
                    </div>
            
                    <p>
                        <button class="btn btn-primary btn-lg" id="btn-guardar">Registrar</button>
                    </p>
            
                </div>
            
            </div>
             
        </div>
        

    </div>
    

    <script src="../assets/js/scripts.js"></script>
    <script src="../assets/bootstrap/js/popper.min.js"></script>
    <script src="../assets/bootstrap/js/bootstrap.js"></script>
    <script>

        $(function (){
            var hoy = new Date().toISOString().split('T')[0]
            var editando = false

            //--------------------Asignatura----------------------
            //id global de asignatura
            let $idA = $('#txt-id-asignatura')

            //llenar la tabla de asignatura
            function llenarTablaAsignaturas(){
                $('#tdata-asignatura').empty()
                var queryAsignatura = `select *
                                       from Asignatura`
                
                db.transaction(tx => {
                    tx.executeSql(queryAsignatura, [], (tx, result) => {
    
                        if(result.rows.length > 0) {
    
                            for(let i = 0; i < result.rows.length; i++) {
    
                                let item = result.rows.item(i)
    
                                var tr = `<tr id="fila-${item.idAsignatura}">
                                            <td>${item.nombreAsignatura}</td>
                                            <td class="text-center"><a class="a-editar" 
                                                                       data-pk="${item.idAsignatura}" 
                                                                       data-nasignatura="${item.nombreAsignatura}"
                                                                       href="#">
                                                                       <span>&#9997</span></a></td>
                                            <td class="text-center"><a class="a-eliminar" 
                                                                     data-pk="${item.idAsignatura}" 
                                                                     data-nasignatura="${item.nombreAsignatura}"
                                                                     href="#">&#128465</a></td>
                                          </tr>`
                                $('#tdata-asignatura').append(tr)
                            }
    
                        }
    
                    })
                })                
            
            }

            llenarTablaAsignaturas()

            //insertar y actualizar una nueva asignatura
            $('#btn-guardar-asignatura').on('click', function() {
                let $nombreAsignatura = $('#txt-nombre-asignatura')
                let $addClase = document.getElementById('btn-add-clase')


                let queryA = `insert into Asignatura(nombreAsignatura)
                              values(?)`

                let queryEdit = `update Asignatura
                                 set nombreAsignatura = (?)
                                 where idAsignatura = (?)`
                
                if($nombreAsignatura.val().trim() === '') {
                    $nombreAsignatura.focus();
                    $nombreAsignatura.css({'border-width':'2px','border-color': 'red'});
                    setTimeout(() => {
                            $nombreAsignatura.fadeIn(1000, function () {
                            $nombreAsignatura.css({'border-width':'1px', 
                            'border-color': 'lightgrey'});
                            })
                        }, 1000)
                    return;
                }

                db.transaction(tx => {

                    if(editando) {
                        tx.executeSql(queryEdit, [$nombreAsignatura.val(), $idA.val()])
                        llenarTablaAsignaturas()
                        
                        let o = {
                            buttons: ['Si', 'No'],
                            message: `Asignatura: ${$nombreAsignatura.val()}, editada correctamente`,
                            title: 'Éxito',
                            type: 'info'
                        }

                        dialog.showMessageBox(o)
                        $nombreAsignatura.val('')

                        /*$('#btn-add-clase').fadeIn('slow', function () {
                            $addClase.style.display = 'block';
                        })*/
                        editando = false
                    } else {
                        tx.executeSql(queryA, [$nombreAsignatura.val()])

                        let o = {
                            buttons: ['Si', 'No'],
                            message: `Asignatura: ${$nombreAsignatura.val()}, agregada con éxito`,
                            title: 'Éxito',
                            type: 'info'
                        }

                        dialog.showMessageBox(o)

                        llenarTablaAsignaturas()
                        $nombreAsignatura.val('')
                        /*$('#btn-add-clase').fadeIn('slow', function () {
                            $addClase.style.display = 'block';
                        })*/
                    }

                })                
                
            })

            $(document).on('click', '.a-editar', function (e) {
                e.preventDefault()
                let $txtNombre = $('#txt-nombre-asignatura')
                let $btnAsig = $('#btn-guardar-asignatura')
                
                let dato = $(this).data('nasignatura')
                let id = $(this).data('pk')

                let options = {
                    buttons: ['Si', 'No'],
                    message: `¿Desea editar: ${dato}?`,
                    title: 'Confirmación',
                    type: 'info'
                }

                dialog.showMessageBox(options).then(result => {
                    if(result.response === 0) {                        
                        $btnAsig.html('Editar')
                        $txtNombre.val(dato)
                        $idA.val(id)
                        editando = true                    
                    }
                })

            })
            
            //eliminar una asignatura
            $(document).on('click', '.a-eliminar', function(e) {
                e.preventDefault()

                let query = `delete from Asignatura
                             where idAsignatura = (?)`
                
                let dato = $(this).data('nasignatura')
                let id = $(this).data('pk')

                let options = {
                    buttons: ['Si', 'No'],
                    message: `¿Desea eliminar: ${dato}?`,
                    title: 'Confirmación',
                    type: 'warning'
                }

                dialog.showMessageBox(options).then(result => {
                    if(result.response === 0) {
                        db.transaction(tx => {
                            tx.executeSql(query, [id])
                            $('#fila-'+id).fadeOut(function() {
                                $(this).remove()
                            })
                            llenarTablaAsignaturas()
                        })
                    }

                    
                })
            })

            //--------------------Asignatura----------------------

            //----------------------Periodo-----------------------
            $('#fecha-comienzo').val(hoy)
            $('#fecha-fin').val(hoy)

            //llenar la tabla de periodos
            function llenarTablaPeriodos() {
                $('#tdata-periodo').empty()
                let query = `select *
                             from Periodo`
                
                db.transaction(tx => {
                tx.executeSql(query, [], (tx, result) => {

                    if(result.rows.length > 0) {

                        for(let i = 0; i < result.rows.length; i++) {

                            let item = result.rows.item(i)

                            var tr = `<tr>
                                        <td>${item.numPeriodo}</td>
                                        <td>${item.fechaPeriodo}</td>
                                        <td>${item.finPeriodo}</td>
                                        <td class="text-center"><a class="a-eliminar" data-pk="${item.idPeriodo}" href="#"><span>&#128257</span></a></td>
                                        <td class="text-center"><a class="a-eliminar" data-pk="${item.idPeriodo}" href="#">&#128465</a></td>
                                        </tr>`
                            $('#tdata-periodo').append(tr)
                        }

                    }

                     })
                })
            }

            llenarTablaPeriodos()

            $('#btn-guardar-periodo').on('click', function() {
                let $nombrePeriodo = $('#txt-periodo')
                let $fComienzo =     $('#fecha-comienzo')
                let $fFin =          $('#fecha-fin')
                let queryP = `insert into Periodo(numPeriodo,
                                                  fechaPeriodo,
                                                  finPeriodo,
                                                  estadoPeriodo)
                              values(?, ?, ?, 1)`
                
                //validaciones
                if($nombrePeriodo.val().trim() === '') {
                    $nombrePeriodo.focus();
                    $nombrePeriodo.css({'border-width':'2px','border-color': 'red'});
                    setTimeout(() => {
                        $nombrePeriodo.fadeIn(1000, function () {
                            $nombrePeriodo.css({'border-width':'1px', 
                                'border-color': 'lightgrey'});
                        })
                    }, 1000)
                    return;
                }

                if($fFin.val() === hoy) {
                    $fFin.focus();
                    $fFin.css({'border-width':'2px','border-color': 'red'});
                    setTimeout(() => {
                        $fFin.fadeIn(1000, function () {
                            $fFin.css({'border-width':'1px', 
                                'border-color': 'lightgrey'});
                        })
                    }, 1000)
                    return;
                }

                db.transaction(tx => {
                    tx.executeSql(queryP, [
                        $nombrePeriodo.val(),
                        $fComienzo.val(),
                        $fFin.val()
                    ])

                    dialog.showMessageBox({message:`Periodo: ${$nombrePeriodo.val()}, ingresado con éxito.`})
                    $nombrePeriodo.val(0)
                    $fComienzo.val(hoy)
                    $fFin.val(hoy)
                    llenarTablaPeriodos()
                })
            })

            function meses(hoy, proximo){
                let mesNuevo = `${hoy.substring(0, 5)}${parseFloat(hoy.substring(5, 7)) + parseFloat(proximo)}${hoy.substring(7,hoy.length)}`
                return mesNuevo
            }

            //----------------------Periodo-----------------------

        })

    </script>
</body>
</html>